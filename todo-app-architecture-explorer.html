<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo App 架构探索器</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden;
    }
    .container {
      display: grid; grid-template-columns: 280px 1fr;
      grid-template-rows: 1fr auto; height: 100vh; gap: 1px; background: #1e293b;
    }
    .sidebar {
      background: #1e293b; padding: 20px; overflow-y: auto; border-right: 1px solid #334155;
    }
    .sidebar h2 {
      font-size: 14px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 12px;
    }
    .preset-buttons { display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px; }
    .preset-btn {
      background: #334155; border: 1px solid #475569; color: #e2e8f0;
      padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px;
      transition: all 0.2s;
    }
    .preset-btn:hover { background: #475569; }
    .preset-btn.active { background: #3b82f6; border-color: #3b82f6; }
    .layer-toggles, .connection-toggles { margin-bottom: 24px; }
    .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
    .checkbox-label {
      display: flex; align-items: center; gap: 8px; cursor: pointer;
      padding: 6px; border-radius: 4px; transition: background 0.2s;
    }
    .checkbox-label:hover { background: #334155; }
    input[type="checkbox"] {
      width: 16px; height: 16px; cursor: pointer;
    }
    .color-indicator {
      width: 12px; height: 12px; border-radius: 2px; flex-shrink: 0;
    }
    .comments-section { margin-top: 24px; }
    .comment-item {
      background: #334155; padding: 12px; border-radius: 6px;
      margin-bottom: 8px; border-left: 3px solid #3b82f6;
    }
    .comment-header {
      display: flex; justify-content: space-between; align-items: start;
      margin-bottom: 6px;
    }
    .comment-target { font-weight: 600; font-size: 13px; color: #60a5fa; }
    .comment-file { font-size: 11px; color: #94a3b8; margin-top: 2px; }
    .comment-text { font-size: 13px; line-height: 1.5; color: #cbd5e1; }
    .delete-comment-btn {
      background: #ef4444; border: none; color: white; padding: 4px 8px;
      border-radius: 4px; cursor: pointer; font-size: 11px;
    }
    .delete-comment-btn:hover { background: #dc2626; }
    .canvas-container {
      background: #0f172a; position: relative; overflow: hidden;
      display: flex; flex-direction: column;
    }
    .zoom-controls {
      position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; z-index: 10;
    }
    .zoom-btn {
      background: #1e293b; border: 1px solid #475569; color: #e2e8f0;
      width: 36px; height: 36px; border-radius: 6px; cursor: pointer;
      font-size: 18px; display: flex; align-items: center; justify-content: center;
    }
    .zoom-btn:hover { background: #334155; }
    .svg-canvas { flex: 1; width: 100%; height: 100%; }
    .legend {
      position: absolute; bottom: 20px; left: 20px; background: #1e293b;
      padding: 12px; border-radius: 8px; border: 1px solid #475569;
    }
    .legend-title { font-size: 12px; font-weight: 600; margin-bottom: 8px; }
    .legend-item {
      display: flex; align-items: center; gap: 8px; font-size: 11px;
      margin-bottom: 4px;
    }
    .legend-line {
      width: 24px; height: 2px;
    }
    .prompt-section {
      grid-column: 2; background: #1e293b; padding: 20px;
      border-top: 1px solid #334155; max-height: 200px; overflow-y: auto;
    }
    .prompt-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .prompt-header h3 { font-size: 14px; color: #94a3b8; }
    .copy-btn {
      background: #3b82f6; border: none; color: white; padding: 8px 16px;
      border-radius: 6px; cursor: pointer; font-size: 13px;
    }
    .copy-btn:hover { background: #2563eb; }
    .copy-btn.copied { background: #10b981; }
    .prompt-text {
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 13px; line-height: 1.6; color: #cbd5e1; white-space: pre-wrap;
    }
    .modal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000; align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: #1e293b; padding: 24px; border-radius: 12px;
      width: 90%; max-width: 500px; border: 1px solid #475569;
    }
    .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .modal-subtitle { font-size: 13px; color: #94a3b8; margin-bottom: 16px; }
    .modal-textarea {
      width: 100%; min-height: 120px; background: #0f172a; border: 1px solid #475569;
      color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: inherit;
      font-size: 14px; resize: vertical;
    }
    .modal-actions {
      display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;
    }
    .modal-btn {
      padding: 8px 16px; border-radius: 6px; cursor: pointer;
      font-size: 14px; border: none;
    }
    .modal-btn-primary { background: #3b82f6; color: white; }
    .modal-btn-primary:hover { background: #2563eb; }
    .modal-btn-secondary { background: #334155; color: #e2e8f0; }
    .modal-btn-secondary:hover { background: #475569; }
    svg text { user-select: none; }
    .node { cursor: pointer; transition: all 0.2s; }
    .node:hover rect { stroke-width: 2; }
    .node.has-comment rect { stroke-width: 3; stroke: #3b82f6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>视图预设</h2>
      <div class="preset-buttons">
        <button class="preset-btn active" data-preset="full">完整系统</button>
        <button class="preset-btn" data-preset="frontend">前端视图</button>
        <button class="preset-btn" data-preset="backend">后端视图</button>
        <button class="preset-btn" data-preset="dataflow">数据流</button>
      </div>
      <h2>显示层级</h2>
      <div class="layer-toggles checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" data-layer="ui" checked>
          <span class="color-indicator" style="background: #dbeafe;"></span>
          <span>UI 层</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" data-layer="logic" checked>
          <span class="color-indicator" style="background: #dcfce7;"></span>
          <span>业务逻辑</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" data-layer="api" checked>
          <span class="color-indicator" style="background: #fef3c7;"></span>
          <span>API 层</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" data-layer="data" checked>
          <span class="color-indicator" style="background: #fce7f3;"></span>
          <span>数据层</span>
        </label>
      </div>
      <h2>连接类型</h2>
      <div class="connection-toggles checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" data-connection="data-flow" checked>
          <span class="color-indicator" style="background: #3b82f6;"></span>
          <span>数据流</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" data-connection="event" checked>
          <span class="color-indicator" style="background: #ef4444;"></span>
          <span>事件</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" data-connection="api-call" checked>
          <span class="color-indicator" style="background: #10b981;"></span>
          <span>API 调用</span>
        </label>
      </div>
      <h2>评论 (<span id="comment-count">0</span>)</h2>
      <div class="comments-section" id="comments-list"></div>
    </div>
    <div class="canvas-container">
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-reset">⟲</button>
        <button class="zoom-btn" id="zoom-out">−</button>
      </div>
      <svg class="svg-canvas" id="canvas" viewBox="0 0 1200 800">
        <defs>
          <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="#3b82f6"/>
          </marker>
          <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="#10b981"/>
          </marker>
          <marker id="arrow-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="#ef4444"/>
          </marker>
        </defs>
        <g id="connections"></g>
        <g id="nodes"></g>
      </svg>
      <div class="legend">
        <div class="legend-title">连接类型</div>
        <div class="legend-item">
          <div class="legend-line" style="background: #3b82f6;"></div>
          <span>数据流</span>
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #10b981; border-top: 2px dashed #10b981; background: none;"></div>
          <span>API 调用</span>
        </div>
        <div class="legend-item">
          <div class="legend-line" style="background: #ef4444; border-top: 2px dashed #ef4444; background: none;"></div>
          <span>事件</span>
        </div>
      </div>
    </div>
    <div class="prompt-section">
      <div class="prompt-header">
        <h3>生成的提示词</h3>
        <button class="copy-btn" id="copy-prompt">复制提示词</button>
      </div>
      <div class="prompt-text" id="prompt-output"></div>
    </div>
  </div>
  <div class="modal" id="comment-modal">
    <div class="modal-content">
      <div class="modal-title" id="modal-title"></div>
      <div class="modal-subtitle" id="modal-subtitle"></div>
      <textarea class="modal-textarea" id="modal-textarea" placeholder="在此输入您的评论、问题或建议..."></textarea>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" id="modal-cancel">取消</button>
        <button class="modal-btn modal-btn-primary" id="modal-save">保存评论</button>
      </div>
    </div>
  </div>
  <script>
    // 架构节点定义
    const nodes = [
      // UI 层
      { id: 'html', label: 'index.html', subtitle: 'index.html', x: 100, y: 50, w: 140, h: 50, layer: 'ui', color: '#dbeafe' },
      { id: 'input', label: 'Todo Input', subtitle: '#todo-input', x: 280, y: 50, w: 140, h: 50, layer: 'ui', color: '#dbeafe' },
      { id: 'list', label: 'Todo List', subtitle: '#todo-list', x: 460, y: 50, w: 140, h: 50, layer: 'ui', color: '#dbeafe' },
      { id: 'filters', label: 'Filter Buttons', subtitle: '.filter-btn', x: 640, y: 50, w: 140, h: 50, layer: 'ui', color: '#dbeafe' },
      { id: 'counter', label: 'Task Counter', subtitle: '#task-count', x: 820, y: 50, w: 140, h: 50, layer: 'ui', color: '#dbeafe' },

      // 业务逻辑层
      { id: 'app', label: 'App Controller', subtitle: 'app.js', x: 280, y: 180, w: 160, h: 50, layer: 'logic', color: '#dcfce7' },
      { id: 'addTodo', label: 'addTodo()', subtitle: 'app.js:183', x: 100, y: 280, w: 140, h: 50, layer: 'logic', color: '#dcfce7' },
      { id: 'createTodo', label: 'createTodoElement()', subtitle: 'app.js:219', x: 280, y: 280, w: 180, h: 50, layer: 'logic', color: '#dcfce7' },
      { id: 'updateCounter', label: 'updateTaskCounter()', subtitle: 'app.js:454', x: 500, y: 280, w: 180, h: 50, layer: 'logic', color: '#dcfce7' },
      { id: 'applyFilter', label: 'applyFilter()', subtitle: 'app.js:470', x: 720, y: 280, w: 140, h: 50, layer: 'logic', color: '#dcfce7' },
      { id: 'editMode', label: 'Edit Functions', subtitle: 'app.js:391-446', x: 900, y: 280, w: 140, h: 50, layer: 'logic', color: '#dcfce7' },

      // API 层
      { id: 'loadTodos', label: 'loadTodos()', subtitle: 'app.js:67', x: 200, y: 410, w: 140, h: 50, layer: 'api', color: '#fef3c7' },
      { id: 'saveTodo', label: 'saveTodo()', subtitle: 'app.js:102', x: 380, y: 410, w: 140, h: 50, layer: 'api', color: '#fef3c7' },
      { id: 'updateTodo', label: 'updateTodo()', subtitle: 'app.js:131', x: 560, y: 410, w: 140, h: 50, layer: 'api', color: '#fef3c7' },
      { id: 'deleteTodo', label: 'deleteTodo()', subtitle: 'app.js:159', x: 740, y: 410, w: 140, h: 50, layer: 'api', color: '#fef3c7' },

      // 数据层
      { id: 'backend', label: 'Backend API', subtitle: 'localhost:5000/api', x: 300, y: 540, w: 180, h: 50, layer: 'data', color: '#fce7f3' },
      { id: 'database', label: 'PostgreSQL', subtitle: 'todo-backend', x: 540, y: 540, w: 160, h: 50, layer: 'data', color: '#fce7f3' },
    ];

    // 连接定义
    const connections = [
      // UI 到业务逻辑
      { from: 'input', to: 'app', type: 'event', label: 'Enter/Click' },
      { from: 'list', to: 'app', type: 'event', label: 'Click' },
      { from: 'filters', to: 'app', type: 'event', label: 'Filter Change' },

      // 业务逻辑内部
      { from: 'app', to: 'addTodo', type: 'data-flow', label: 'Add' },
      { from: 'addTodo', to: 'createTodo', type: 'data-flow', label: 'Create UI' },
      { from: 'createTodo', to: 'updateCounter', type: 'data-flow', label: 'Update' },
      { from: 'app', to: 'applyFilter', type: 'data-flow', label: 'Filter' },
      { from: 'app', to: 'editMode', type: 'data-flow', label: 'Edit' },

      // 业务逻辑到 API
      { from: 'addTodo', to: 'saveTodo', type: 'api-call', label: 'POST' },
      { from: 'app', to: 'loadTodos', type: 'api-call', label: 'GET' },
      { from: 'editMode', to: 'updateTodo', type: 'api-call', label: 'PUT' },
      { from: 'createTodo', to: 'deleteTodo', type: 'api-call', label: 'DELETE' },

      // API 到数据层
      { from: 'loadTodos', to: 'backend', type: 'api-call', label: 'HTTP' },
      { from: 'saveTodo', to: 'backend', type: 'api-call', label: 'HTTP' },
      { from: 'updateTodo', to: 'backend', type: 'api-call', label: 'HTTP' },
      { from: 'deleteTodo', to: 'backend', type: 'api-call', label: 'HTTP' },
      { from: 'backend', to: 'database', type: 'data-flow', label: 'SQL' },

      // 数据回流
      { from: 'loadTodos', to: 'createTodo', type: 'data-flow', label: 'Todos[]' },
      { from: 'updateCounter', to: 'counter', type: 'data-flow', label: 'Count' },
      { from: 'applyFilter', to: 'list', type: 'data-flow', label: 'Filter' },
    ];

    // 状态管理
    const state = {
      zoom: 1,
      layers: { ui: true, logic: true, api: true, data: true },
      connections: { 'data-flow': true, 'event': true, 'api-call': true },
      comments: [],
      currentNode: null,
      preset: 'full'
    };

    // 预设配置
    const presets = {
      full: { ui: true, logic: true, api: true, data: true },
      frontend: { ui: true, logic: true, api: false, data: false },
      backend: { ui: false, logic: false, api: true, data: true },
      dataflow: { ui: true, logic: true, api: true, data: true }
    };

    // 获取节点位置
    function getNodeCenter(nodeId) {
      const node = nodes.find(n => n.id === nodeId);
      if (!node) return { x: 0, y: 0 };
      return { x: node.x + node.w / 2, y: node.y + node.h / 2 };
    }

    // 绘制连接线
    function drawConnection(conn) {
      const from = getNodeCenter(conn.from);
      const to = getNodeCenter(conn.to);

      const dx = to.x - from.x;
      const dy = to.y - from.y;
      const curve = Math.abs(dx) * 0.5;

      const path = `M ${from.x} ${from.y} C ${from.x + curve} ${from.y}, ${to.x - curve} ${to.y}, ${to.x} ${to.y}`;

      const colors = { 'data-flow': '#3b82f6', 'event': '#ef4444', 'api-call': '#10b981' };
      const markers = { 'data-flow': 'arrow-blue', 'event': 'arrow-red', 'api-call': 'arrow-green' };
      const dashArrays = { 'data-flow': 'none', 'event': '4,4', 'api-call': '6,3' };

      return `<path d="${path}"
        stroke="${colors[conn.type]}"
        stroke-width="2"
        fill="none"
        stroke-dasharray="${dashArrays[conn.type]}"
        marker-end="url(#${markers[conn.type]})"
        data-type="${conn.type}" />`;
    }

    // 绘制节点
    function drawNode(node) {
      const hasComment = state.comments.some(c => c.target === node.id);
      const commentClass = hasComment ? 'has-comment' : '';

      return `<g class="node ${commentClass}" data-id="${node.id}" data-layer="${node.layer}">
        <rect x="${node.x}" y="${node.y}" width="${node.w}" height="${node.h}"
          fill="${node.color}" stroke="#64748b" stroke-width="1" rx="6" />
        <text x="${node.x + node.w/2}" y="${node.y + node.h/2 - 8}"
          text-anchor="middle" font-size="14" font-weight="600" fill="#0f172a">
          ${node.label}
        </text>
        <text x="${node.x + node.w/2}" y="${node.y + node.h/2 + 8}"
          text-anchor="middle" font-size="11" fill="#475569">
          ${node.subtitle}
        </text>
      </g>`;
    }

    // 渲染整个图表
    function renderDiagram() {
      const connectionsEl = document.getElementById('connections');
      const nodesEl = document.getElementById('nodes');

      // 过滤可见节点和连接
      const visibleNodes = nodes.filter(n => state.layers[n.layer]);
      const visibleNodeIds = new Set(visibleNodes.map(n => n.id));
      const visibleConnections = connections.filter(c =>
        state.connections[c.type] &&
        visibleNodeIds.has(c.from) &&
        visibleNodeIds.has(c.to)
      );

      // 绘制连接
      connectionsEl.innerHTML = visibleConnections.map(drawConnection).join('');

      // 绘制节点
      nodesEl.innerHTML = visibleNodes.map(drawNode).join('');

      // 添加节点点击事件
      document.querySelectorAll('.node').forEach(nodeEl => {
        nodeEl.addEventListener('click', () => {
          const nodeId = nodeEl.dataset.id;
          openCommentModal(nodeId);
        });
      });
    }

    // 打开评论模态框
    function openCommentModal(nodeId) {
      const node = nodes.find(n => n.id === nodeId);
      if (!node) return;

      state.currentNode = nodeId;
      document.getElementById('modal-title').textContent = node.label;
      document.getElementById('modal-subtitle').textContent = node.subtitle;

      // 如果已有评论，填充到文本框
      const existingComment = state.comments.find(c => c.target === nodeId);
      document.getElementById('modal-textarea').value = existingComment ? existingComment.text : '';

      document.getElementById('comment-modal').classList.add('active');
      document.getElementById('modal-textarea').focus();
    }

    // 保存评论
    function saveComment() {
      const text = document.getElementById('modal-textarea').value.trim();
      if (!text) return;

      const node = nodes.find(n => n.id === state.currentNode);
      if (!node) return;

      // 删除旧评论（如果存在）
      state.comments = state.comments.filter(c => c.target !== state.currentNode);

      // 添加新评论
      state.comments.push({
        id: Date.now(),
        target: state.currentNode,
        targetLabel: node.label,
        targetFile: node.subtitle,
        text: text
      });

      closeCommentModal();
      updateCommentsList();
      updatePrompt();
      renderDiagram();
    }

    // 关闭评论模态框
    function closeCommentModal() {
      document.getElementById('comment-modal').classList.remove('active');
      document.getElementById('modal-textarea').value = '';
      state.currentNode = null;
    }

    // 更新评论列表
    function updateCommentsList() {
      const listEl = document.getElementById('comments-list');
      document.getElementById('comment-count').textContent = state.comments.length;

      if (state.comments.length === 0) {
        listEl.innerHTML = '<p style="color: #64748b; font-size: 13px;">点击架构图中的组件添加评论</p>';
        return;
      }

      listEl.innerHTML = state.comments.map(comment => `
        <div class="comment-item">
          <div class="comment-header">
            <div>
              <div class="comment-target">${comment.targetLabel}</div>
              <div class="comment-file">${comment.targetFile}</div>
            </div>
            <button class="delete-comment-btn" onclick="deleteComment(${comment.id})">删除</button>
          </div>
          <div class="comment-text">${comment.text}</div>
        </div>
      `).join('');
    }

    // 删除评论
    window.deleteComment = function(commentId) {
      state.comments = state.comments.filter(c => c.id !== commentId);
      updateCommentsList();
      updatePrompt();
      renderDiagram();
    };

    // 更新提示词
    function updatePrompt() {
      const promptEl = document.getElementById('prompt-output');

      if (state.comments.length === 0) {
        promptEl.textContent = '点击架构图中的组件添加评论后，这里将生成相应的提示词。';
        return;
      }

      const visibleLayers = Object.entries(state.layers)
        .filter(([_, visible]) => visible)
        .map(([layer, _]) => {
          const layerNames = { ui: 'UI层', logic: '业务逻辑层', api: 'API层', data: '数据层' };
          return layerNames[layer];
        })
        .join('、');

      let prompt = `这是 Todo App 的架构图，当前显示：${visibleLayers}。\n\n`;
      prompt += `针对以下组件的反馈和建议：\n\n`;

      state.comments.forEach(comment => {
        prompt += `**${comment.targetLabel}** (${comment.targetFile}):\n`;
        prompt += `${comment.text}\n\n`;
      });

      promptEl.textContent = prompt;
    }

    // 复制提示词
    document.getElementById('copy-prompt').addEventListener('click', function() {
      const text = document.getElementById('prompt-output').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const btn = this;
        btn.textContent = '已复制!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = '复制提示词';
          btn.classList.remove('copied');
        }, 2000);
      });
    });

    // 缩放控制
    document.getElementById('zoom-in').addEventListener('click', () => {
      state.zoom = Math.min(state.zoom + 0.2, 2);
      updateZoom();
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
      state.zoom = Math.max(state.zoom - 0.2, 0.5);
      updateZoom();
    });

    document.getElementById('zoom-reset').addEventListener('click', () => {
      state.zoom = 1;
      updateZoom();
    });

    function updateZoom() {
      const canvas = document.getElementById('canvas');
      const baseWidth = 1200;
      const baseHeight = 800;
      const newWidth = baseWidth / state.zoom;
      const newHeight = baseHeight / state.zoom;
      const offsetX = (baseWidth - newWidth) / 2;
      const offsetY = (baseHeight - newHeight) / 2;
      canvas.setAttribute('viewBox', `${offsetX} ${offsetY} ${newWidth} ${newHeight}`);
    }

    // 预设按钮
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const preset = btn.dataset.preset;
        state.preset = preset;
        Object.assign(state.layers, presets[preset]);

        // 更新复选框状态
        document.querySelectorAll('[data-layer]').forEach(checkbox => {
          checkbox.checked = state.layers[checkbox.dataset.layer];
        });

        renderDiagram();
        updatePrompt();
      });
    });

    // 层级切换
    document.querySelectorAll('[data-layer]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        state.layers[checkbox.dataset.layer] = checkbox.checked;
        renderDiagram();
        updatePrompt();
      });
    });

    // 连接类型切换
    document.querySelectorAll('[data-connection]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        state.connections[checkbox.dataset.connection] = checkbox.checked;
        renderDiagram();
      });
    });

    // 模态框事件
    document.getElementById('modal-save').addEventListener('click', saveComment);
    document.getElementById('modal-cancel').addEventListener('click', closeCommentModal);

    // 点击模态框外部关闭
    document.getElementById('comment-modal').addEventListener('click', (e) => {
      if (e.target.id === 'comment-modal') {
        closeCommentModal();
      }
    });

    // 键盘快捷键
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('comment-modal').classList.contains('active')) {
        closeCommentModal();
      }
      if (e.key === 'Enter' && e.ctrlKey && document.getElementById('comment-modal').classList.contains('active')) {
        saveComment();
      }
    });

    // 初始化
    renderDiagram();
    updateCommentsList();
    updatePrompt();
  </script>
</body>
</html>
